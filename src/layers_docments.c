/*============================================================================*/
/*                            Layer?3: Scheduling                              */
/*============================================================================*/
/*
   Purpose: Cooperatively schedule each service ?thread? so they share one
   main stack without full RTOS overhead.

   ????????????????????????????????????????????????????????????????????????????
   ? 1) Protothreads Setup                                                 ?
   ?    ? Download pt.h + lc.h + lc-switch.h                                 ?
   ?    ? Place under src/third_party/protothreads/                          ?
   ?    ? Add that folder to XC32 ?Additional Include Directories?           ?
   ????????????????????????????????????????????????????????????????????????????
                     ?
                     ?
   ????????????????????????????????????????????????????????????????????????????
   ? 2) protothreads.h                                                       ?
   ?    // extern pt structs & thread prototypes                             ?
   ?    extern struct pt ptSensor, ptTelit, ptEsp32, ptEth, ptCLI;           ?
   ?    PT_THREAD( SensorThread(struct pt *pt) );                             ?
   ?    PT_THREAD( TelitThread (struct pt *pt) );                             ?
   ?    PT_THREAD( Esp32Thread(struct pt *pt) );                             ?
   ?    PT_THREAD( EthThread   (struct pt *pt) );                             ?
   ?    PT_THREAD( CliThread   (struct pt *pt) );                             ?
   ?    void Protothreads_Init(void);                                         ?
   ????????????????????????????????????????????????????????????????????????????
                     ?
                     ?
   ????????????????????????????????????????????????????????????????????????????
   ? 3) protothreads.c                                                       ?
   ?    #include <stdint.h>                                                  ?
   ?    #include "protothreads.h"                                            ?
   ?    struct pt ptSensor, ptTelit, ptEsp32, ptEth, ptCLI;                  ?
   ?                                                                          ?
   ?    void Protothreads_Init(void) {                                       ?
   ?        PT_INIT(&ptSensor);                                              ?
   ?        PT_INIT(&ptTelit);                                               ?
   ?        PT_INIT(&ptEsp32);                                               ?
   ?        PT_INIT(&ptEth);                                                 ?
   ?        PT_INIT(&ptCLI);                                                 ?
   ?    }                                                                     ?
   ?                                                                          ?
   ?    PT_THREAD( SensorThread(struct pt *pt) ) {                           ?
   ?        static uint32_t t0;                                               ?
   ?        PT_BEGIN(pt);                                                     ?
   ?        while (1) {                                                       ?
   ?            t0 = msTicks;                                                 ?
   ?            HAL_ADC_StartConversion();                                    ?
   ?            PT_WAIT_UNTIL(pt, HAL_ADC_ConversionComplete());              ?
   ?            processSensor(HAL_ADC_GetResult());                           ?
   ?            PT_WAIT_UNTIL(pt, (msTicks - t0) >= 1000);                     ?
   ?        }                                                                 ?
   ?        PT_END(pt);                                                       ?
   ?    }                                                                     ?
   ?                                                                          ?
   ?    // ? TelitThread, Esp32Thread, EthThread, CliThread similar ?         ?
   ????????????????????????????????????????????????????????????????????????????
                     ?
                     ?
   ????????????????????????????????????????????????????????????????????????????
   ? 4) main.c Integration                                                   ?
   ?    extern volatile uint32_t msTicks;                                     ?
   ?    Protothreads_Init();                                                  ?
   ?    while (1) {                                                           ?
   ?        SYS_Tasks();            // Harmony internals                      ?
   ?        SensorThread(&ptSensor);                                          ?
   ?        TelitThread (&ptTelit);                                           ?
   ?        Esp32Thread(&ptEsp32);                                            ?
   ?        EthThread  (&ptEth);                                              ?
   ?        CliThread  (&ptCLI);                                              ?
   ?    }                                                                     ?
   ????????????????????????????????????????????????????????????????????????????
*/
